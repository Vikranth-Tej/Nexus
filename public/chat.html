<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Chat</title>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="chat-page">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm border-bottom">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="index.html">Nexus</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto" id="nav-items">
                    <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i> Home</a>
                    </li>

                    <li class="nav-item"><a class="nav-link" href="blog.html"><i class="fas fa-blog me-1"></i> Blog</a>
                    </li>
                    <li class="nav-item"><a class="nav-link active" href="chat.html"><i
                                class="fas fa-comments me-1"></i> Chat</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> <span id="navUsername">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="profile.html"><i class="fas fa-id-card me-2"></i>
                                    Profile</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                        class="fas fa-sign-out-alt me-2"></i> Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="wa-container">
        <!-- Sidebar -->
        <div class="wa-sidebar">
            <div class="wa-header">
                <!-- User Avatar -->
                <div class="wa-avatar shadow-sm" id="currentUserAvatar" title="My Profile">
                    <!-- Injected via JS -->
                </div>
                <!-- Header Icons -->
                <div class="wa-header-icons">
                    <a href="profile.html" class="wa-icon-btn" title="Profile"><i class="fas fa-user-circle"></i></a>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="wa-search-bar">
                <div class="wa-search-input-wrapper">
                    <i class="fas fa-search text-muted"></i>
                    <input type="text" class="wa-search-input" placeholder="Search or start new chat">
                </div>
            </div>

            <!-- Contact List -->
            <div class="wa-contact-list" id="userList">
                <div class="text-center mt-5">
                    <div class="spinner-border text-success spinner-border-sm" role="status"></div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="wa-chat-area">
            <!-- Default Empty State -->
            <div id="emptyState" class="wa-empty-state">
                <div class="p-4 rounded-circle bg-light mb-4 shadow-sm">
                    <i class="fas fa-comments text-gradient-nexus" style="font-size: 48px;"></i>
                </div>
                <h2 class="mb-2">Welcome to Nexus Chat</h2>
                <p class="text-muted">
                    Select a conversation from the sidebar to start messaging.
                </p>
            </div>

            <!-- Active Chat (Hidden by default) -->
            <div id="activeChat" style="display: none; flex-direction: column; height: 100%;">
                <!-- Chat Header -->
                <div class="wa-chat-header">
                    <div class="d-flex align-items-center">
                        <div class="wa-avatar me-3" id="chatHeaderAvatar">
                            <!-- Injected -->
                        </div>
                        <div style="cursor: pointer;">
                            <h6 class="m-0 text-dark" id="chatHeaderName">User</h6>
                            <span class="small text-muted" id="chatHeaderStatus">click here for contact info</span>
                        </div>
                    </div>
                    <div class="wa-header-icons">
                        <button class="wa-icon-btn"><i class="fas fa-search"></i></button>
                        <button class="wa-icon-btn"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>

                <!-- Messages -->
                <div class="wa-chat-messages" id="messagesArea">
                    <!-- Messages will be injected here -->
                </div>

                <!-- Input Area -->
                <div class="wa-input-area">
                    <button class="wa-icon-btn"><i class="far fa-smile"></i></button>
                    <button class="wa-icon-btn"><i class="fas fa-plus"></i></button>

                    <div class="wa-input-wrapper">
                        <input type="text" class="wa-input-field" id="messageInput" placeholder="Type a message">
                    </div>

                    <button class="wa-icon-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                    <!-- Or microphone icon if empty -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('token');
        const currentUser = JSON.parse(localStorage.getItem('user'));

        if (!token) {
            window.location.href = 'login.html';
        }

        if (currentUser) {
            document.getElementById('navUsername').innerText = currentUser.username;
        }

        // Initialize user avatar
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        currentUserAvatar.innerHTML = `<div class="d-flex align-items-center justify-content-center h-100 bg-light text-primary fw-bold" style="font-size: 18px;">${currentUser.username.charAt(0).toUpperCase()}</div>`;

        // Initialize Socket.IO
        const socket = io();
        socket.emit('join', currentUser._id);

        let selectedUserId = null;
        let selectedUsername = null;

        // Fetch Users
        async function fetchUsers() {
            try {
                const res = await fetch('/api/auth/users', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await res.json();
                const userList = document.getElementById('userList');
                userList.innerHTML = '';

                if (users.length === 0) {
                    userList.innerHTML = '<div class="p-3 text-center small text-muted">No contacts found.</div>';
                    return;
                }

                users.forEach(user => {
                    if (user._id === currentUser._id) return;
                    const div = document.createElement('div');
                    div.className = 'wa-contact-item';
                    div.id = `user-${user._id}`;
                    div.onclick = () => selectUser(user._id, user.username);

                    div.innerHTML = `
                        <div class="wa-avatar">
                            <div class="d-flex align-items-center justify-content-center h-100 bg-secondary text-white fw-bold">
                                ${user.username.charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="wa-contact-info">
                            <div class="wa-contact-top">
                                <span class="wa-contact-name">${user.username}</span>
                                <span class="wa-contact-time">12:30 PM</span>
                            </div>
                            <div class="wa-contact-bottom">
                                <span class="wa-last-message">Start a conversation</span>
                            </div>
                        </div>
                    `;
                    userList.appendChild(div);
                });

            } catch (error) {
                console.error(error);
            }
        }

        async function selectUser(userId, username) {
            selectedUserId = userId;
            selectedUsername = username;

            // UI Update
            document.querySelectorAll('.wa-contact-item').forEach(el => el.classList.remove('active'));
            const selectedItem = document.getElementById(`user-${userId}`);
            if (selectedItem) selectedItem.classList.add('active');

            // Show Chat Area
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('activeChat').style.display = 'flex';

            // Update Header
            document.getElementById('chatHeaderName').innerText = username;
            document.getElementById('chatHeaderAvatar').innerHTML = `<div class="d-flex align-items-center justify-content-center h-100 bg-secondary text-white fw-bold">${username.charAt(0).toUpperCase()}</div>`;

            // Clear and Fetch Messages
            const messagesArea = document.getElementById('messagesArea');
            messagesArea.innerHTML = '';
            fetchMessages(userId);
        }

        async function fetchMessages(userId) {
            try {
                const res = await fetch(`/api/messages/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const messages = await res.json();
                messages.forEach(msg => {
                    appendMessage(msg, msg.sender === currentUser._id ? 'sent' : 'received');
                });
            } catch (error) {
                console.error(error);
            }
        }

        function appendMessage(msg, type) {
            const div = document.createElement('div');
            div.className = `wa-message ${type}`;

            // Format Time
            const date = new Date(msg.createdAt || Date.now());
            const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            div.innerHTML = `
                ${msg.content}
                <span class="wa-message-time">${time}</span>
            `;

            const area = document.getElementById('messagesArea');
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        // Send Logic
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content || !selectedUserId) return;

            socket.emit('sendMessage', {
                senderId: currentUser._id,
                recipientId: selectedUserId,
                content
            });

            appendMessage({ content, createdAt: new Date() }, 'sent');
            input.value = '';
        }

        socket.on('receiveMessage', (msg) => {
            if (msg.sender === selectedUserId) {
                appendMessage(msg, 'received');
            }
        });

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Init
        fetchUsers();

    </script>
</body>

</html>